å¥½ï¼Œå’±ä»¬å…ˆåˆ«çº ç»“ YAML / param äº†ï¼Œå…ˆæŠŠ**è¿™ä¸€å¥—ç³»ç»Ÿåˆ°åº•æ€ä¹ˆè·‘**å®Œæ•´æ¢³ç†ä¸€éï¼Œä½ ä»¥åç…§ç€è¿™ä»½â€œèœè°±â€æ¥å°±è¡Œã€‚

æˆ‘æŒ‰ã€Œä¸€ä¸ªç»ˆç«¯ä¸€æ¡çº¿ã€æ¥æ•´ç†ï¼Œå¹¶ä¸”**åªä¿ç•™ä½ äº²å£ç¡®è®¤â€œèƒ½è·‘èµ·æ¥â€çš„é‚£å‡ æ¡æŒ‡ä»¤**ï¼Œä¸­é—´é‚£äº›è¯•é”™çš„ç‰ˆæœ¬å…¨ä¸¢æ‰ã€‚

---

## ğŸ§© æ•´ä½“ç»“æ„å…ˆå›å¿†ä¸€ä¸‹

ä½ ç°åœ¨è¿™å¥—é“¾è·¯æ˜¯ï¼š

> **PX4 SITL + Gazebo Classic**
> â†’ é€šè¿‡ UDP MAVLink
> â†’ **MAVROS2 (ROS2 Humble)**
> â†’ `/mavros/local_position/odom`ã€`/mavros/imu/data`
> â†’ **ego-swarm çš„ SO3 æ§åˆ¶å™¨ï¼š`so3_control_component_node`**
> â†’ `/so3_cmd`ï¼ˆSO3Commandï¼‰
> â†’ **æ¡¥æ¥èŠ‚ç‚¹ `so3_to_mavros_bridge`**
> â†’ `/mavros/setpoint_raw/attitude`ï¼ˆAttitudeTargetï¼‰
> â†’ PX4 OFFBOARD æ§åˆ¶

ä½ è¦åšçš„ï¼Œå°±æ˜¯åœ¨å‡ ä¸ªç»ˆç«¯é‡ŒæŒ‰é¡ºåºæŠŠè¿™äº›ä¸œè¥¿éƒ½æ‹‰èµ·æ¥ã€‚

---

## 0ï¸âƒ£ ç»Ÿä¸€çº¦å®šï¼šæ¯ä¸ªç»ˆç«¯ã€Œå¼€å±€å§¿åŠ¿ã€

ä»¥å**æ¯å¼€ä¸€ä¸ªæ–°ç»ˆç«¯**ï¼Œå…ˆåšè¿™ä¸¤å¥ï¼ˆé¿å…æ‹¿é”™ç¯å¢ƒï¼‰ï¼š

```bash
source /opt/ros/humble/setup.bash
source ~/egoswarm_ws/install/setup.bash
```

> âš  ä¸è¦åœ¨è¿™äº›ç»ˆç«¯å†å» `source ~/mavros2_ws/...` ä¹‹ç±»çš„æ—§ç¯å¢ƒï¼Œä¼šæŠŠè·¯å¾„æä¹±ã€‚

---

## 1ï¸âƒ£ ç»ˆç«¯ 1ï¼šå¯åŠ¨ PX4 + Gazebo Classic

è¿™ä¸ªç»ˆç«¯åªå¹² PX4 ä»¿çœŸè¿™ä»¶äº‹ã€‚

```bash
cd ~/px4_ws/PX4-Autopilot

# ç”¨ä½ å·²ç»éªŒè¯èƒ½èµ·é£çš„é‚£æ¡æŒ‡ä»¤
# æ¯”å¦‚ï¼ˆç¤ºä¾‹ï¼‰ï¼š
make px4_sitl gazebo-classic
```

> âœ… åˆ¤æ–­æ˜¯å¦æ­£å¸¸ï¼š
>
> * Gazebo é‡Œèƒ½çœ‹åˆ°é£æœº
> * PX4 æ§åˆ¶å°ï¼ˆpxh>ï¼‰é‡Œ `commander takeoff` èƒ½èµ·é£ï¼ˆåœ¨ä½ æ²¡å¼€ MAVROS çš„æ—¶å€™ä¹‹å‰æµ‹è¯•è¿‡æ˜¯ OK çš„ï¼‰

ä¿æŒè¿™ä¸ªç»ˆç«¯ä¸€ç›´å¼€ç€ã€‚

---

## 2ï¸âƒ£ ç»ˆç«¯ 2ï¼šå¯åŠ¨ MAVROSï¼ˆä½ è‡ªå·±å†™çš„ launchï¼‰

ç¡®ä¿ `px4_so3_bridge` å·²ç» build è¿‡ï¼ˆä½ ä¹‹å‰å·²ç»æˆåŠŸè¿‡ï¼ŒçœŸè¦é‡ç¼–è¯‘çš„è¯ï¼‰ï¼š

```bash
cd ~/egoswarm_ws
colcon build --packages-select px4_so3_bridge
```

ä¹‹ååœ¨**æ–°ç»ˆç«¯**ï¼š

```bash
source /opt/ros/humble/setup.bash
source ~/egoswarm_ws/install/setup.bash

ros2 launch px4_so3_bridge mavros_with_config.launch.py
```

ä½ çœ‹åˆ°çš„å…¸å‹æ—¥å¿—åº”è¯¥æ˜¯è¿™æ ·ï¼š

```text
[mavros_node-1] [INFO] [..] [mavros]: FCU URL: udp://:14550@localhost:18570
[mavros_node-1] [INFO] [..] [mavros]: link[1000] detected remote address 1.1
...
```

> âœ… è¯´æ˜ï¼š
>
> * MAVROS å·²ç»é€šè¿‡ `udp://:14550@localhost:18570` è¿ä¸Š PX4 SITL
> * è¿™ä¸€æ­¥æ˜¯ä½ å¤šæ¬¡æˆåŠŸè¿‡çš„

---

## 3ï¸âƒ£ ç»ˆç«¯ 3ï¼šå¯åŠ¨ SO3 æ§åˆ¶å™¨ï¼ˆso3_control_component_nodeï¼‰

**å‰æ**ï¼šego-planner-swarm ä»“åº“å·²ç»åœ¨ `~/egoswarm_ws/src/ego-planner-swarm-ros2_version/...`ï¼Œå¹¶ä¸”ä½ ä¹‹å‰å·²ç» build æˆåŠŸï¼ˆä½ ç¡®è®¤ `so3_control` åŒ…å·²ç»èƒ½ç¼–è¯‘äº†ï¼‰ã€‚

å¦‚éœ€é‡ç¼–è¯‘ï¼š

```bash
cd ~/egoswarm_ws
colcon build --packages-select so3_control
```

ç„¶ååœ¨**æ–°ç»ˆç«¯**ï¼š

```bash
source /opt/ros/humble/setup.bash
source ~/egoswarm_ws/install/setup.bash

ros2 run so3_control so3_control_component_node --ros-args \
  --remap odom:=/mavros/local_position/odom \
  --remap imu:=/mavros/imu/data \
  --remap position_cmd:=/position_cmd \
  --remap so3_cmd:=/so3_cmd
```

> ä½ ä¹‹å‰è·‘è¿™æ¡å‘½ä»¤çš„è¾“å‡ºæ˜¯ï¼š
>
> ```text
> [INFO] [..] [SO3ControlComponent]: start SO3ControlComponent
> [WARN] [..] New publisher discovered ... QoS ä¸å…¼å®¹
> ```
>
> QoS è­¦å‘Šå…ˆæ— è§†ï¼ŒèŠ‚ç‚¹èƒ½èµ·æ¥å°±è¡Œã€‚

æ­¤æ—¶é“¾è·¯å·²ç»å˜æˆï¼š

* MAVROS æä¾› `/mavros/local_position/odom` å’Œ `/mavros/imu/data`
* SO3 æ§åˆ¶å™¨è®¢é˜…è¿™ä¿©ï¼Œå¹¶è®¢é˜… `/position_cmd`
* æ§åˆ¶è¾“å‡º `/so3_cmd`ï¼ˆquadrotor_msgs/SO3Commandï¼‰

---

## 4ï¸âƒ£ ç»ˆç«¯ 4ï¼šå¯åŠ¨æ¡¥æ¥èŠ‚ç‚¹ SO3 â†’ MAVROS

æ¡¥æ¥èŠ‚ç‚¹æºç ï¼ˆç¡®è®¤ä½ ç°åœ¨æ˜¯ç±»ä¼¼è¿™ä¸€ç‰ˆï¼‰ï¼š

```python
#!/usr/bin/env python3
import rclpy
from rclpy.node import Node

from quadrotor_msgs.msg import SO3Command
from mavros_msgs.msg import AttitudeTarget


class SO3Bridge(Node):
    def __init__(self):
        super().__init__('so3_to_mavros_bridge')

        self.sub = self.create_subscription(
            SO3Command,
            'so3_cmd',          # â† æ¥è‡ª so3_control_component
            self.cmd_callback,
            10
        )

        self.pub = self.create_publisher(
            AttitudeTarget,
            '/mavros/setpoint_raw/attitude',
            10
        )

    def cmd_callback(self, msg: SO3Command):
        out = AttitudeTarget()
        out.header.stamp = self.get_clock().now().to_msg()
        out.header.frame_id = "base_link"

        # 1. å§¿æ€ç›´æ¥ç”¨ SO3 æ§åˆ¶å™¨ç®—å‡ºæ¥çš„ orientation
        out.orientation = msg.orientation

        # 2. ï¼ˆç°åœ¨å¯ä»¥å…ˆä¿ç•™æˆ–å…ˆæ³¨é‡Šæ‰ thrustï¼Œçœ‹ä½ åé¢è°ƒè¯•éœ€è¦ï¼‰
        out.thrust = msg.force.z / 15.0

        # 3. å±è”½è§’é€Ÿåº¦ï¼Œä½¿ç”¨å§¿æ€æ§åˆ¶
        out.type_mask = (
            AttitudeTarget.IGNORE_ROLL_RATE  |
            AttitudeTarget.IGNORE_PITCH_RATE |
            AttitudeTarget.IGNORE_YAW_RATE
            # å¦‚æœæƒ³å®Œå…¨å¿½ç•¥æ¨åŠ›ï¼Œå¯ä»¥å†åŠ ä¸€æ¡ï¼š
            # | AttitudeTarget.IGNORE_THRUST
        )

        self.pub.publish(out)


def main(args=None):
    rclpy.init(args=args)
    node = SO3Bridge()
    rclpy.spin(node)
    node.destroy_node()
    rclpy.shutdown()


if __name__ == '__main__':
    main()
```

> âœ… ä½ å·²ç»ç¡®è®¤è¿™ç‰ˆ**èƒ½è¿è¡Œ**ï¼Œåªæ˜¯ä¹‹å‰æœ‰ thrust çš„è­¦å‘Šï¼›
> å¦‚æœåé¢æƒ³å¿«é€Ÿæ¶ˆæ‰é”™è¯¯ï¼Œå°±å†åŠ ä¸Š `IGNORE_THRUST`ï¼ŒæŠŠ `out.thrust` ä¹Ÿå»æ‰ã€‚

è¿è¡Œæ¡¥æ¥èŠ‚ç‚¹ï¼š

```bash
source /opt/ros/humble/setup.bash
source ~/egoswarm_ws/install/setup.bash

ros2 run px4_so3_bridge so3_to_mavros_bridge
```

æ­¤æ—¶å¯ä»¥å¼€ä¸€ä¸ªå°æ£€æŸ¥ï¼š

```bash
ros2 topic hz /mavros/setpoint_raw/attitude
```

ä½ ä¹‹å‰æµ‹è¿‡æ˜¯ï¼š

```text
average rate: ~200 Hz
```

è¯´æ˜ï¼š**æ•´æ¡é“¾è·¯â€œso3_control â†’ bridge â†’ mavrosâ€æ˜¯é€šçš„**ã€‚

---

## 5ï¸âƒ£ ç»ˆç«¯ 5ï¼šæ£€æŸ¥ MAVROS çŠ¶æ€ + ARM + OFFBOARD

è¿™ä¸€ç»ˆç«¯ä¸“é—¨ç”¨æ¥å‘æœåŠ¡ã€çœ‹çŠ¶æ€ã€‚

å…ˆçœ‹ MAVROS è¿æ¥çŠ¶æ€ï¼š

```bash
source /opt/ros/humble/setup.bash
source ~/egoswarm_ws/install/setup.bash

ros2 topic echo /mavros/state
```

ä½ çœ‹åˆ°çš„æ˜¯ç±»ä¼¼ï¼š

```yaml
connected: true
armed: false
guided: true
mode: AUTO.LOITER
system_status: 3 or 4
```

### 5.1 ARMï¼ˆé€šè¿‡ MAVROSï¼‰

```bash
ros2 service call /mavros/mavros/arming mavros_msgs/srv/CommandBool "{value: true}"
```

ä½ ä¹‹å‰æ‰§è¡Œåï¼ŒPX4 é‡Œèƒ½çœ‹åˆ°ï¼š

```text
INFO  [commander] Armed by external command
```

å¹¶ä¸” `/mavros/state` é‡Œå˜æˆï¼š

```yaml
armed: true
```

### 5.2 åˆ‡æ¢ OFFBOARD æ¨¡å¼

```bash
ros2 service call /mavros/mavros/set_mode mavros_msgs/srv/SetMode "{base_mode: 0, custom_mode: 'OFFBOARD'}"
```

> âš  æ³¨æ„ï¼š
>
> * è¿™æ¡å‘½ä»¤è¯­æ³•æœ¬èº«æ˜¯å¯¹çš„
> * å¦‚æœ mode æ²¡å˜ï¼Œå¤šåŠæ˜¯ï¼š
>
>   * OFFBOARD å‰ setpoint æ²¡å‘å¤Ÿï¼ˆè‡³å°‘ 2Hzã€æŒç»­ä¸€æ®µæ—¶é—´ï¼‰
>   * EKF / ä½ç½®ä¼°è®¡çŠ¶æ€ä¸æ»¡è¶³ OFFBOARD æ¡ä»¶
>   * å®‰å…¨æ£€æŸ¥æ²¡è¿‡ï¼ˆä½†ä½ ä¹‹å‰ `pre_flight_checks_pass: True` äº†ï¼‰

è¿™é‡Œåªéœ€è®°ä½ï¼š**æœåŠ¡è°ƒç”¨è¯­æ³•æ˜¯æ­£ç¡®çš„**ã€‚

---

## 6ï¸âƒ£ è°ƒè¯•æ—¶å¸¸ç”¨çš„å‡ æ¡æŒ‡ä»¤ï¼ˆä½ ä»¥åå¯ä»¥å¸¸ç”¨ï¼‰

### âœ” çœ‹ MAVROS å’Œ PX4 ä¹‹é—´çŠ¶æ€

```bash
ros2 topic echo /mavros/state
```

### âœ” çœ‹å§¿æ€ setpoint æ˜¯å¦å‘åˆ°äº† PX4

```bash
ros2 topic hz /mavros/setpoint_raw/attitude
```

### âœ” çœ‹ PX4 MAVLink é“¾è·¯çŠ¶æ€ï¼ˆåœ¨ PX4 ç»ˆç«¯é‡Œï¼‰ï¼š

```bash
pxh> mavlink status
```

ç¡®è®¤æœ‰ä¸€æ¡ï¼š

```text
instance #0:
  transport protocol: UDP (18570, remote port: 14550)
  partner IP: 127.0.0.1
```

---

## âœ… æ€»ç»“ä¸€ä¸‹æ¯ä¸ªç»ˆç«¯å¹²å•¥ï¼ˆæ–¹ä¾¿ä½ ä»¥åå¯¹å·å…¥åº§ï¼‰

1. **ç»ˆç«¯ 1ï¼ˆPX4 + Gazeboï¼‰**

   ```bash
   cd ~/px4_ws/PX4-Autopilot
   make px4_sitl gazebo-classic   # æˆ–ä½ å·²éªŒè¯èƒ½èµ·é£çš„é‚£æ¡
   ```

2. **ç»ˆç«¯ 2ï¼ˆMAVROSï¼‰**

   ```bash
source ~/mavros2_ws/install/setup.bash
ros2 launch mavros mavros_px4.launch.py fcu_url:=udp://:14550@localhost:18570

   ```
ros2 topic echo /so3_cmd


ros2 topic echo /mavros/local_position/odom


ros2 topic echo /mavros/imu/data

3. **ç»ˆç«¯ 3ï¼ˆSO3 æ§åˆ¶å™¨ï¼‰**

cd ~/egoswarm_ws
source install/setup.bash

ros2 run so3_control so3_control_component_node --ros-args \
  --remap odom:=/mavros/local_position/odom \
  --remap imu:=/mavros/imu/data \
  --remap position_cmd:=/position_cmd \
  --remap so3_cmd:=/so3_cmd

ros2 run so3_control so3_control_component_node --ros-args \
  --remap odom:=/mavros/local_position/odom \
  --remap imu:=/mavros/imu/data \
  --remap position_cmd:=/position_cmd \
  --remap so3_cmd:=/so3_cmd   ä»¿çœŸ
  
  ros2 run so3_control so3_control_component_node --ros-args   --remap odom:=/mavros/local_position/odom   --remap imu:=/mavros/imu/data   --remap position_cmd:=/drone_0_planning/pos_cmd   --remap so3_cmd:=/so3_cmd  ç®—æ³•

ros2 launch mavros mavros_px4.launch.py fcu_url:=udp://:14540@localhost:14580


4. **ç»ˆç«¯ 4ï¼ˆæ¡¥æ¥ SO3 â†’ MAVROSï¼‰**

   ```bash
   source /opt/ros/humble/setup.bash
   source ~/egoswarm_ws/install/setup.bash
   ros2 run px4_so3_bridge so3_to_mavros_bridge
   ```

5. **ç»ˆç«¯ 5ï¼ˆæ§åˆ¶ / è°ƒè¯•ï¼‰**

   ```bash
   # çœ‹çŠ¶æ€
   ros2 topic echo /mavros/state

   # ARM
   ros2 service call /mavros/mavros/arming mavros_msgs/srv/CommandBool "{value: true}"

   # OFFBOARD
   ros2 service call /mavros/mavros/set_mode mavros_msgs/srv/SetMode "{base_mode: 0, custom_mode: 'OFFBOARD'}"

   # çœ‹ setpoint æµæ˜¯å¦è¶³å¤Ÿ
   ros2 topic hz /mavros/setpoint_raw/attitude
   ```

ros2 topic pub -r 20 /position_cmd quadrotor_msgs/msg/PositionCommand "{
  header: {frame_id: 'world'},
  position: {x: 0.0, y: 0.0, z: 1.5},
  velocity: {x: 0.0, y: 0.0, z: 0.0},
  acceleration: {x: 0.0, y: 0.0, z: 0.0},
  yaw: 0.0,
  yaw_dot: 0.0,
  kx: [4.0, 4.0, 6.0],
  kv: [2.0, 2.0, 3.0],
  trajectory_id: 1,
  trajectory_flag: 1
}"

---

åé¢ä½ è¦æ˜¯é‡åˆ°**å…·ä½“æŸä¸€æ­¥ä¸å¯¹åŠ²**ï¼ˆæ¯”å¦‚ OFFBOARD è¿›ä¸å»ã€é£æœºä¹±é£ã€so3 æ§åˆ¶è¾“å‡ºå¼‚å¸¸ï¼‰ï¼Œä½ å°±å‘Šè¯‰æˆ‘â€œç°åœ¨å¡åœ¨ç¬¬å‡ æ­¥ã€å“ªæ¡æŒ‡ä»¤è¾“å‡ºå•¥â€ï¼Œæˆ‘å†åœ¨è¿™å¥—â€œå¹²å‡€æµç¨‹â€çš„åŸºç¡€ä¸Šå¸®ä½  debugï¼Œå°±ä¸ä¼šå†åƒåˆšæ‰é‚£æ ·è¶Šæ”¹è¶Šä¹±äº†ã€‚









cd ~/px4_ws/PX4-Autopilot
make px4_sitl gazebo-classic

ros2 launch mavros mavros_px4.launch.py fcu_url:=udp://:14540@localhost:14580
	ros2 run px4_ego_bridge px4_to_ego_odom_bridge
ros2 run so3_control so3_control_component_node --ros-args   --remap odom:=/mavros/local_position/odom   --remap imu:=/mavros/imu/data   --remap position_cmd:=/drone_0_planning/pos_cmd   --remap so3_cmd:=/so3_cmd
ros2 run px4_so3_bridge so3_to_mavros_bridge
cd ~/egoswarm_ws
source install/setup.bash
ros2 launch ego_planner single_run_in_sim.launch.py
source install/setup.bash

ros2 param set /mavros/setpoint_raw thrust_scaling 1.0




ros2 run px4_ego_bridge px4_to_ego_odom_bridge





ros2 param set /mavros/setpoint_raw thrust_scaling 2.0


ros2 param set /mavros/setpoint_raw thrust_scaling 2.0
ros2 run px4_so3_bridge so3_to_mavros_bridge









ros2 launch ego_planner single_run_in_sim.launch.py   use_dynamic:=false   odom_topic:=odom_world
